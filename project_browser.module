<?php

// $Id$
/**
 * @file
 * Project Browser module.
 * Authored by Leighton Whiting for Google Summer of Code 2011
 * 
 * This module will provide a new UI for admins to easily browse modules and themes from their
 * admin pages, and install them.
 */

/**
 * Display help and module information
 */
function project_browser_help($path, $arg) {
  $output = '';
  switch ($path) {
    case "admin/help#project_browser":
      $output .= '<p>'.  t("Provides a UI for users to browse for and install new modules and themes from
      within their Drupal admin interface.") .'</p>';
      break;
  }
  return $output;
}

/**
 * Implementation of hook_perm().
 */
function project_browser_permission() {
  return array(
    'use project browser' => array(
      'title' => t('Use Project Browser'),
      'description' => t('This allows the user to browse for and install new modules and themes using Project Browser.'),
      'restrict access' => TRUE,
    )
  );
}

/**
 * Implementation of hook_menu().
 */
function project_browser_menu() {
  $items = array();
  $items['project_browser'] = array(
    'description' => 'A page where users can browse for modules and add them to an install queue.',
    'page callback' => 'project_browser_browser_page',
    'access arguments' => array('use project browser'),
    'type' => MENU_CALLBACK,
  );
  $items['admin/settings/project_browser'] = array(
    'title' => 'Project Browser Settings',
    'description' => 'Set the various Project Browser Settings here',
    'page callback' => 'drupal_get_form',
    'page arguments' => array('project_browser_admin'),
    'access arguments' => array('access administration pages'),
    'type' => MENU_NORMAL_ITEM,
  );
  
  $items['admin/project_browser/modules'] = array(
    'title' => 'Modules',
    'description' => 'Browse and search for new modules',
    'page callback' => 'project_browser_page',
    'page arguments' => array('module'),
    'access arguments' => array('use project browser'),
    'file' => 'project_browser.pages.inc',
    'type' => MENU_DEFAULT_LOCAL_TASK
  );
  
  $items['admin/project_browser/themes'] = array(
    'title' => 'Themes',
    'description' => 'Browse and search for new themes',
    'page callback' => 'project_browser_page',
    'page arguments' => array('theme'),
    'access arguments' => array('use project browser'),
    'file' => 'project_browser.pages.inc',
    'type' => MENU_LOCAL_TASK
  );
  
  $items['admin/project_browser/install/%'] = array(
    'title' => 'Install',
    'page callback' => 'project_browser_installation_page',
    'page arguments' => array(2, 3),
    'access arguments' => array('use project browser'),
    'type' => MENU_NORMAL_ITEM,
    'file' => 'project_browser.pages.inc',
  );
  return $items;
}

// ======================================
// Administration Page:
// ======================================

/**
 * Admin Settings Form
 */
function project_browser_admin() {
  $form['main'] = array(
    '#type' => 'fieldset',
    '#title' => t('Main Settings'),
    '#collapsible' => FALSE,
    '#collapsed' => FALSE,
    );
  $form['main']['project_browser_servers'] = array(
    '#type' => 'textarea',
    '#title' => t('Servers'),
    '#default_value' => variable_get('project_browser_servers', ''),
    '#description' => t("Add new servers to use for the Project Browser, one per line, in 
      the 'url|Server Name' format. Drupal.org is added by default, and doesn't need to be 
      set here."),
    '#required' => TRUE,
  );

  return system_settings_form($form);
}

// ======================================
// Pages:
// ======================================

/**
 * A page where the user can browse modules and themes, and add them to an install queue
 */
function project_browser_browser_page() {
	// TODO - Finish this
}

// ======================================
// Functions:
// ======================================

/**
 * Fetches results from the servers based on the parameters passed in
 * 
 * $filters should be an associative array with the following keys:
 * array(
 *   'drupal_version' => '6.x', // The Major Version of Drupal that is running on the Client
 *   'text' => 'Views', // The text that was entered as the search query, or 'all'
 *   'type' => 'module', // The type of project being searched
 * )
 * 
 * The project_browser_fetch_results($filters) call returns an array like this:
 * 
 * array(
 *   'views' => array( // The key is the project (unique) shortname
 *     'type' => 'module', // The type of project this is. Can be 'module' or 'theme'
 *     'title' => 'Views',
 *     'short_name' => 'views',
 *     'author' => 'merlinofchaos',
 *     'description' => "Long project description ...",
 *     'image' => 'http://www.example.com/image.jpg', // Absolute url to the image, if any
 *     'usage' => '542312', // How many Downloads the module has had
 *     'project_url' => 'http://www.drupal.org/projects/views', // Absolute url to the project page, if any
 *     'update_url' => 'http://updates.drupal.org/release-history/views/7.x', // The absolute url of the update checker, formatted like how Drupal.org Update Status does it
 *     'last_updated' => '12342523', // UNIX Timestamp of when the project was last updated
 *     'rating' => '9.6', // A rating on a scale of 1 to 10 of the project, if available
 *     'dependencies' => array( // An array of the dependencies of this module
 *         'ctools',
 *       ),
 *   ),
 *   'short_name_2 => array( ... ),
 * );
 * 
 * @param $filters
 *   An associative array of queries to use to filter results
 * @return array
 *   Returns an array of results
 */
function project_browser_fetch_results($filters) {
	$servers = project_browser_get_servers();
	
	$results = array();
	
	foreach ($servers as $url => $name) {
		$results_raw = xmlrpc($url, array(
	    'project_browser_server.fetch_results' => array($filters),
	  ));
	  
	  // Check for errors
	  $error = xmlrpc_error();
	  if ($error->is_error) {
	  	drupal_set_message(t("Encountered an error when trying to fetch results from @name. Error @code : @message",
	  	  array('@name' => $name, '@code' => $error->code, '@message' => $error->message)));
	  	continue;
	  }
	  
	  if (is_array($results_raw) AND !empty($results_raw)) {
		  // Merge the results
		  $results = array_merge($results, $results_raw);
	  }
	}
  
  return $results;
}

/**
 * Gets the servers to use for fetching results
 * 
 * @return array
 *   Returns an associative array of servers, populated from the project_browser_servers variable, 
 *   in 'url => name' format
 */
function project_browser_get_servers() {
	$servers = array(
    'http://www.drupal.org/xmlrpc.php' => 'Drupal.org',
	);
	if (variable_get('project_browser_servers', '')) {
		// TODO - Process the variable and add the servers to the list
	}
	
	return $servers;
}